---
- name: Install cRPG Web UI dependencies
  command: "yarn --cwd {{ playbook_dir }}/../src/WebUI install"
  delegate_to: localhost
  become: false

- name: Generate cRPG Web UI environment
  template:
    src: env.production.local.j2
    dest: "{{ playbook_dir }}/../src/WebUI/.env.production.local"
  delegate_to: localhost
  become: false

- name: Build cRPG Web UI
  command: "yarn --cwd {{ playbook_dir }}/../src/WebUI build"
  delegate_to: localhost
  become: false

- name: Check that a cRPG Web UI version is already present
  stat:
    path: "{{ crpg_ui_path }}"
  register: crpg_ui_path_stat_result

- name: Copy cRPG Web UI to host
  copy:
    src: "{{ playbook_dir }}/../src/WebUI/dist/"
    dest: "{{ crpg_ui_path }}_new"
    mode: u=rwX,g=rX,o=rX
    owner: www-data
    group: www-data

- name: Disable old cRPG Web UI
  command: "mv {{ crpg_ui_path }} {{ crpg_ui_path }}_old"
  when: crpg_ui_path_stat_result.stat.exists

- name: Enable new cRPG Web UI
  command: "mv {{ crpg_ui_path }}_new {{ crpg_ui_path }}"

# new files have different name so it's important to remove them manually
- name: Clean old cRPG Web UI
  file:
    path: "{{ crpg_ui_path }}_old"
    state: absent
  when: crpg_ui_path_stat_result.stat.exists
